<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-translate="page-title">Subscription Success - EchoVision</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../public/css/thanks.css" />
    <style>
      .hidden {
        display: none !important;
      }

      .dashboard-btn,
      .nav-start-now-btn {
        background-color: #ff9800;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: bold;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease-in-out;
        border: none;
        cursor: pointer;
        box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
        margin-right: 10px;
      }
      .dashboard-btn:hover,
      .nav-start-now-btn:hover {
        background-color: #e68900;
        transform: scale(1.05);
      }
      .dashboard-btn:active,
      .nav-start-now-btn:active {
        transform: scale(0.95);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <img
        src="https://cdn.builder.io/api/v1/image/assets/TEMP/f323aebef58277caab7dbe39260b9674dd4a09ac63495998aff7e633a7743b82?placeholderIfAbsent=true"
        alt="EchoVision Logo"
        loading="lazy"
        class="logo"
      />
      <nav class="nav-container">
        <ul class="nav-links">
          <li>
            <a href="../index.html" class="nav-link" data-translate="nav-home"
              >Home</a
            >
          </li>
          <li>
            <a
              href="../pricing/pricing.html"
              class="nav-link"
              data-translate="nav-pricing"
              >Pricing</a
            >
          </li>
          <li>
            <a
              href="../about_us/about.html"
              class="nav-link"
              data-translate="nav-about"
              >About Us</a
            >
          </li>
          <li>
            <a
              href="../download/download.html"
              class="nav-link"
              data-translate="nav-download"
              >Download</a
            >
          </li>
          <!-- Start Now nav button (visible only when logged in and subscribed) -->
          <li id="start-now-li" class="hidden">
            <a
              href="../camera/camera.html"
              id="start-now-navbar-btn"
              class="nav-start-now-btn"
              data-translate="start-now"
              >Start Now</a
            >
          </li>
        </ul>
        <div class="auth-buttons">
          <a
            href="../auth/login.html"
            class="login-btn"
            id="login-btn"
            data-translate="login-btn"
            style="display: none"
            >Login</a
          >
          <a
            href="../auth/logout.html"
            class="logout-btn hidden"
            id="logout-btn"
            data-translate="logout-btn"
            >Logout</a
          >
          <a
            href="../auth/signup.html"
            class="signup-btn"
            id="signup-btn"
            data-translate="signup-btn"
            style="display: none"
            >Signup</a
          >
          <button id="lang-toggle" class="lang-btn" data-translate="lang-btn">
            AR
          </button>
          <a
            href="../../EchoVision-Frontend-Web-Dashboard/index.html"
            class="dashboard-btn hidden"
            id="dashboard-btn"
            data-translate="dashboard-btn"
            >Dashboard</a
          >
        </div>
      </nav>
    </header>

    <main class="main-content">
      <img
        loading="lazy"
        src="https://cdn.builder.io/api/v1/image/assets/TEMP/1e85aca3e830040e3c54a99a036997f31fa7dabd36ce0b3bce70018aaddc130e?placeholderIfAbsent=true&apiKey=5334285123ac4d9d800ee080d967bbe4"
        class="success-icon"
        alt="Subscription Success Icon"
      />
      <h1 class="success-title" data-translate="success-title">
        Thanks For Subscription
      </h1>
      <a href="../index.html" class="return-link" data-translate="return-home"
        >Return to Home</a
      >
    </main>

    <footer class="footer">
      <p class="copyright" data-translate="copyright">
        © 2025, EchoVision, Inc. All Rights Reserved.
      </p>
    </footer>

    <script>
      const translations = {
        en: {
          "page-title": "Subscription Success - EchoVision",
          "nav-home": "Home",
          "nav-pricing": "Pricing",
          "nav-about": "About Us",
          "nav-download": "Download",
          "login-btn": "Login",
          "signup-btn": "Signup",
          "logout-btn": "Logout",
          "dashboard-btn": "Dashboard",
          "lang-btn": "AR",
          "success-title": "Thanks For Subscription",
          "return-home": "Return to Home",
          "start-now": "Start Now",
          copyright: "© 2025, EchoVision, Inc. All Rights Reserved.",
          "Authentication required. Please log in.":
            "Authentication required. Please log in.",
          "Failed to create subscription.": "Failed to create subscription.",
          "Invalid subscription data.": "Invalid subscription data.",
        },
        ar: {
          "page-title": "نجاح الاشتراك - إيكو ڤيجن",
          "nav-home": "الرئيسية",
          "nav-pricing": "الأسعار",
          "nav-about": "من نحن",
          "nav-download": "تحميل",
          "login-btn": "تسجيل الدخول",
          "signup-btn": "إنشاء حساب",
          "logout-btn": "تسجيل الخروج",
          "dashboard-btn": "لوحة التحكم",
          "lang-btn": "EN",
          "success-title": "شكرًا لاشتراكك",
          "return-home": "العودة إلى الصفحة الرئيسية",
          "start-now": "ابدأ الآن",
          copyright: "© 2025، إيكو ڤيجن، جميع الحقوق محفوظة.",
          "Authentication required. Please log in.":
            "التوثيق مطلوب. يرجى تسجيل الدخول.",
          "Failed to create subscription.": "فشل في إنشاء الاشتراك.",
          "Invalid subscription data.": "بيانات الاشتراك غير صالحة.",
        },
      };

      function updateLanguage(lang) {
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
        document.getElementById("lang-toggle").textContent =
          translations[lang]["lang-btn"];

        document.querySelectorAll("[data-translate]").forEach((el) => {
          const key = el.getAttribute("data-translate");
          if (translations[lang][key]) {
            el.textContent = translations[lang][key];
          }
        });

        localStorage.setItem("selectedLanguage", lang);
      }

      // Check the token's expiry
      function checkTokenExpiry() {
        const tokenExpiry = localStorage.getItem("tokenExpiry");
        if (tokenExpiry && Date.now() > Number(tokenExpiry)) {
          console.log("Token expired");
          logoutUser();
          return false;
        }
        return true;
      }

      // Check login status and update UI
      function checkLoginStatus() {
        const authToken = localStorage.getItem("auth_token");
        const loginBtn = document.getElementById("login-btn");
        const signupBtn = document.getElementById("signup-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const dashboardBtn = document.getElementById("dashboard-btn");
        const startNowLi = document.getElementById("start-now-li");

        if (!authToken) {
          // Guest mode
          loginBtn.style.display = "inline-block";
          signupBtn.style.display = "inline-block";
          logoutBtn.classList.add("hidden");
          dashboardBtn.classList.add("hidden");
          startNowLi.classList.add("hidden");
          localStorage.removeItem("isRefreshed");
          return;
        }

        // If token exists, check if it is expired
        if (!checkTokenExpiry()) return;

        const isSubscribed = localStorage.getItem("is_subscribed");
        const isAdmin = localStorage.getItem("isAdmin") === "true";

        // Logged-in mode
        loginBtn.style.display = "none";
        signupBtn.style.display = "none";
        logoutBtn.classList.remove("hidden");

        // Show Dashboard button if admin
        if (isAdmin) {
          dashboardBtn.classList.remove("hidden");
        } else {
          dashboardBtn.classList.add("hidden");
        }

        // Show "Start Now" if the user is subscribed
        if (isSubscribed === "true") {
          startNowLi.classList.remove("hidden");
        } else {
          startNowLi.classList.add("hidden");
        }
      }

      // Logout function
      function logoutUser() {
        // Clear all user-related localStorage keys except language preference
        localStorage.removeItem("auth_token");
        localStorage.removeItem("isAdmin");
        localStorage.removeItem("is_subscribed");
        localStorage.removeItem("tokenExpiry");
        localStorage.removeItem("loggedInUser");
        localStorage.removeItem("isRefreshed");
        // Redirect to the same page
        window.location.href = "thanks.html";
      }

      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize language
        const savedLang = localStorage.getItem("selectedLanguage") || "en";
        updateLanguage(savedLang);

        // Language toggle
        document
          .getElementById("lang-toggle")
          .addEventListener("click", function () {
            const newLang =
              document.documentElement.lang === "en" ? "ar" : "en";
            updateLanguage(newLang);
          });

        // Check login status
        checkLoginStatus();

        // Add logout event listener
        document.getElementById("logout-btn").addEventListener("click", (e) => {
          e.preventDefault(); // Prevent default navigation to logout.html
          logoutUser();
        });

        // Hit the subscriptions endpoint
        const token = localStorage.getItem("auth_token");
        if (!token) {
          alert(
            savedLang === "ar"
              ? translations.ar["Authentication required. Please log in."]
              : translations.en["Authentication required. Please log in."]
          );
          window.location.href = "../index.html";
          return;
        }

        // Validate user_id and pricing_id
        const user_id = localStorage.getItem("user_id");
        const pricing_id = localStorage.getItem("selectedPlanId");
        if (!user_id || !pricing_id) {
          alert(
            savedLang === "ar"
              ? translations.ar["Invalid subscription data."]
              : translations.en["Invalid subscription data."]
          );
          window.location.href = "../index.html";
          return;
        }

        const subscriptionData = {
          user_id: parseInt(user_id), // Ensure it's an integer
          pricing_id: parseInt(pricing_id), // Ensure it's an integer
        };

        try {
          const response = await fetch("http://localhost:3000/subscriptions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(subscriptionData),
          });

          // Log the response for debugging
          console.log("Response status:", response.status);
          const data = await response.json();
          console.log("Response body:", data);

          // Check if the subscription was created (even if status isn't 2xx)
          if (
            response.status === 200 ||
            response.status === 201 ||
            (data && data.success)
          ) {
            console.log("Subscription created successfully");
            localStorage.setItem("is_subscribed", "true");
          } else {
            throw new Error(
              `Failed to create subscription: ${response.status} - ${
                data.message || "Unknown error"
              }`
            );
          }
        } catch (error) {
          console.error("Error creating subscription:", error);
          alert(
            savedLang === "ar"
              ? translations.ar["Failed to create subscription."]
              : translations.en["Failed to create subscription."]
          );
          window.location.href = "../index.html";
        }
      });
    </script>
  </body>
</html>
